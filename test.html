<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div id="post">
        <script src="ai-summary.js"></script>
        <!-- 文章内容 -->
        <article class="post-content  line-numbers" id="article-container">

            <h1 style="" id="%E6%8A%80%E6%9C%AF%E6%A0%88"><br>技术栈</h1>
            <ol>
                <li>
                    <p style="">tkinter</p>
                </li>
                <li>
                    <p style="">pyinstaller</p>
                </li>
                <li>
                    <p style="">ntplib</p>
                </li>
            </ol>
            <div class="code-toolbar">
                <pre class="language-python line-numbers close"
                    tabindex="0"><code class="hljs language-python" data-highlighted="yes"><span class="token keyword">import</span> os
    <span class="token keyword">import</span> webbrowser
    <span class="token keyword">import</span> ntplib
    <span class="token keyword">import</span> datetime
    <span class="token keyword">import</span> tkinter <span class="token keyword">as</span> tk
    <span class="token keyword">from</span> tkinter <span class="token keyword">import</span> messagebox<span class="token punctuation">,</span> simpledialog
    <span class="token keyword">import</span> threading
    <span class="token keyword">import</span> requests
    <span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token punctuation">,</span> ImageTk
    <span class="token keyword">import</span> ttkbootstrap <span class="token keyword">as</span> ttk
    <span class="token keyword">import</span> ctypes
    <span class="token keyword">import</span> json
    
    
    <span class="token keyword">class</span> <span class="token class-name">SyncTimeApp</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>root <span class="token operator">=</span> root
    self<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token string">"1.0.0"</span>  <span class="token comment"># 更新版本号格式为x.x.x</span>
    self<span class="token punctuation">.</span>update_api <span class="token operator">=</span> <span class="token string">"https://synctimeapi.vercel.app/api/version"</span>  <span class="token comment"># 替换为您的Vercel API地址</span>
    self<span class="token punctuation">.</span>about_api <span class="token operator">=</span> <span class="token string">"https://synctimeapi.vercel.app/api/about"</span>  <span class="token comment"># 新增关于页API地址</span>
    self<span class="token punctuation">.</span>last_check_time <span class="token operator">=</span> <span class="token number">0</span>
    self<span class="token punctuation">.</span>check_interval <span class="token operator">=</span> <span class="token number">3600</span>  <span class="token comment"># 1小时</span>
    
    self<span class="token punctuation">.</span>screenwidth <span class="token operator">=</span> self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>winfo_screenwidth<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>screenheight <span class="token operator">=</span> self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>winfo_screenheight<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    self<span class="token punctuation">.</span>ntp_servers_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ntp_servers.json"</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>load_ntp_servers<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>primary_ntp_server <span class="token operator">=</span> self<span class="token punctuation">.</span>ntp_servers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>ntp_servers <span class="token keyword">else</span> <span class="token boolean">None</span>
    
    self<span class="token punctuation">.</span>setup_window<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>create_widgets<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>create_menu<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>load_icon<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 确保加载图标</span>
    
    <span class="token keyword">def</span> <span class="token function">setup_window</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"时间同步工具"</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment"># 将位置坐标转换为整数</span>
    x_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>screenwidth <span class="token operator">-</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    y_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>screenheight <span class="token operator">-</span> <span class="token number">310</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    size_geo <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token number">500</span><span class="token punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token number">310</span><span class="token punctuation">}</span></span><span class="token string">+</span><span class="token interpolation"><span class="token punctuation">{</span>x_pos<span class="token punctuation">}</span></span><span class="token string">+</span><span class="token interpolation"><span class="token punctuation">{</span>y_pos<span class="token punctuation">}</span></span><span class="token string">'</span></span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>geometry<span class="token punctuation">(</span>size_geo<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>protocol<span class="token punctuation">(</span><span class="token string">"WM_DELETE_WINDOW"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>close_window<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">create_widgets</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建一个主框架并居中</span>
    main_frame <span class="token operator">=</span> tk<span class="token punctuation">.</span>Frame<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">,</span> bg<span class="token operator">=</span><span class="token string">"white"</span><span class="token punctuation">)</span>
    main_frame<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 标签</span>
    self<span class="token punctuation">.</span>text <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>main_frame<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"时间同步"</span><span class="token punctuation">,</span> bg<span class="token operator">=</span><span class="token string">"white"</span><span class="token punctuation">,</span> fg<span class="token operator">=</span><span class="token string">"black"</span><span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>text<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 按钮</span>
    self<span class="token punctuation">.</span>button_synctime <span class="token operator">=</span> tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>main_frame<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"时间同步"</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>synctime<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>button_close <span class="token operator">=</span> tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>main_frame<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"关闭"</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>close_window<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>button_synctime<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>button_close<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">create_menu</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    top_menu <span class="token operator">=</span> tk<span class="token punctuation">.</span>Menu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">,</span> tearoff<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    menu_more <span class="token operator">=</span> tk<span class="token punctuation">.</span>Menu<span class="token punctuation">(</span>top_menu<span class="token punctuation">,</span> tearoff<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    top_menu<span class="token punctuation">.</span>add_cascade<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">"更多"</span><span class="token punctuation">,</span> menu<span class="token operator">=</span>menu_more<span class="token punctuation">)</span>
    menu_more<span class="token punctuation">.</span>add_command<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">"检查更新"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>CheckVersion<span class="token punctuation">)</span>
    menu_more<span class="token punctuation">.</span>add_command<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">"关于"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>about_window<span class="token punctuation">)</span>
    top_menu<span class="token punctuation">.</span>add_command<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">"设置"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>open_settings<span class="token punctuation">)</span>  <span class="token comment"># 添加设置按钮</span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>config<span class="token punctuation">(</span>menu<span class="token operator">=</span>top_menu<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">load_icon</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取当前脚本的绝对路径</span>
    script_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
    icon_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_dir<span class="token punctuation">,</span> <span class="token string">"app.ico"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>icon_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        icon_image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>icon_path<span class="token punctuation">)</span>
        photo <span class="token operator">=</span> ImageTk<span class="token punctuation">.</span>PhotoImage<span class="token punctuation">(</span>icon_image<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>iconphoto<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> photo<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>icon_image <span class="token operator">=</span> photo  <span class="token comment"># 保持引用，防止被垃圾回收</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"图标加载成功: </span><span class="token interpolation"><span class="token punctuation">{</span>icon_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"图标文件不存在: </span><span class="token interpolation"><span class="token punctuation">{</span>icon_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> AttributeError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"AttributeError: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"加载图标失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">close_window</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">synctime</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_admin<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 显示同步动画</span>
    self<span class="token punctuation">.</span>show_sync_animation<span class="token punctuation">(</span><span class="token punctuation">)</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>sync_time_task<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
    messagebox<span class="token punctuation">.</span>showwarning<span class="token punctuation">(</span><span class="token string">"权限不足"</span><span class="token punctuation">,</span> <span class="token string">"同步时间需要管理员权限。请以管理员身份运行程序。"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">is_admin</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> ctypes<span class="token punctuation">.</span>windll<span class="token punctuation">.</span>shell32<span class="token punctuation">.</span>IsUserAnAdmin<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>
    
    <span class="token keyword">def</span> <span class="token function">sync_time_task</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>primary_ntp_server<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> messagebox<span class="token punctuation">.</span>showerror<span class="token punctuation">(</span><span class="token string">"错误"</span><span class="token punctuation">,</span> <span class="token string">"没有可用的NTP服务器。"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    
    c <span class="token operator">=</span> ntplib<span class="token punctuation">.</span>NTPClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> c<span class="token punctuation">.</span>request<span class="token punctuation">(</span>self<span class="token punctuation">.</span>primary_ntp_server<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> messagebox<span class="token punctuation">.</span>showerror<span class="token punctuation">(</span><span class="token string">"错误"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"无法连接到NTP服务器: </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>primary_ntp_server<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    
    <span class="token keyword">if</span> response<span class="token punctuation">:</span>
        current_time <span class="token operator">=</span> response<span class="token punctuation">.</span>tx_time
        dt <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>current_time<span class="token punctuation">)</span>
        _date <span class="token operator">=</span> dt<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>
        _time <span class="token operator">=</span> dt<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%H:%M:%S"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"系统当前时间"</span><span class="token punctuation">,</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"北京标准时间"</span><span class="token punctuation">,</span> _date<span class="token punctuation">,</span> _time<span class="token punctuation">)</span>
        a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c_sec <span class="token operator">=</span> _time<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
        c_sec <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>c_sec<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.5</span>
        _time <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>b<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>c_sec<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'date </span><span class="token interpolation"><span class="token punctuation">{</span> _date <span class="token punctuation">}</span></span><span class="token string"> &amp;&amp; time </span><span class="token interpolation"><span class="token punctuation">{</span> _time <span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
            str1 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"同步后时间: </span><span class="token interpolation"><span class="token punctuation">{</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d %H:%M:%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> messagebox<span class="token punctuation">.</span>showinfo<span class="token punctuation">(</span><span class="token string">"成功同步"</span><span class="token punctuation">,</span> str1<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> messagebox<span class="token punctuation">.</span>showwarning<span class="token punctuation">(</span><span class="token string">"失败"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"时间同步失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> messagebox<span class="token punctuation">.</span>showerror<span class="token punctuation">(</span><span class="token string">"错误"</span><span class="token punctuation">,</span> <span class="token string">"无法连接到任何NTP服务器。"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> messagebox<span class="token punctuation">.</span>showerror<span class="token punctuation">(</span><span class="token string">"错误"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"发生异常: </span><span class="token interpolation"><span class="token punctuation">{</span>ex<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token comment"># 隐藏同步动画</span>
    self<span class="token punctuation">.</span>hide_sync_animation<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">CheckVersion</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建并显示加载动画窗口</span>
    loading_window <span class="token operator">=</span> tk<span class="token punctuation">.</span>Toplevel<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>set_window_icon<span class="token punctuation">(</span>loading_window<span class="token punctuation">)</span>  <span class="token comment"># 设置图标</span>
    loading_window<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"检查更新"</span><span class="token punctuation">)</span>
    loading_window<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    x_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>screenwidth <span class="token operator">-</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    y_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>screenheight <span class="token operator">-</span> <span class="token number">250</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    size_geo <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'400x250+</span><span class="token interpolation"><span class="token punctuation">{</span>x_pos<span class="token punctuation">}</span></span><span class="token string">+</span><span class="token interpolation"><span class="token punctuation">{</span>y_pos<span class="token punctuation">}</span></span><span class="token string">'</span></span>
    loading_window<span class="token punctuation">.</span>geometry<span class="token punctuation">(</span>size_geo<span class="token punctuation">)</span>
    
    <span class="token comment"># 显示加载动画</span>
    loading_label <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>loading_window<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"正在检查更新，请稍候..."</span><span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    loading_label<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    progress <span class="token operator">=</span> ttk<span class="token punctuation">.</span>Progressbar<span class="token punctuation">(</span>loading_window<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'indeterminate'</span><span class="token punctuation">)</span>
    progress<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>tk<span class="token punctuation">.</span>X<span class="token punctuation">)</span>
    progress<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 启动线程进行版本检查</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>check_version_task<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>loading_window<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> loading_label<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">check_version_task</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loading_window<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> loading_label<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>self<span class="token punctuation">.</span>update_api<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        latest_version <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'version'</span><span class="token punctuation">)</span>
        update_url <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'updateUrl'</span><span class="token punctuation">)</span>
        announcement <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'announcement'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>version <span class="token operator">==</span> latest_version<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>show_message<span class="token punctuation">(</span>
                loading_window<span class="token punctuation">,</span>
                progress<span class="token punctuation">,</span>
                <span class="token string">"你已经是最新版。"</span><span class="token punctuation">,</span>
                <span class="token string">"info"</span><span class="token punctuation">,</span>
                announcement
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>compare_versions<span class="token punctuation">(</span>self<span class="token punctuation">.</span>version<span class="token punctuation">,</span> latest_version<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>show_update_options<span class="token punctuation">(</span>
                loading_window<span class="token punctuation">,</span>
                progress<span class="token punctuation">,</span>
                <span class="token string">"你的版本已经落后了，是否更新？"</span><span class="token punctuation">,</span>
                update_url<span class="token punctuation">,</span>
                announcement
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>show_message<span class="token punctuation">(</span>
                loading_window<span class="token punctuation">,</span>
                progress<span class="token punctuation">,</span>
                <span class="token string">"当前版本高于最新版本。"</span><span class="token punctuation">,</span>
                <span class="token string">"warning"</span><span class="token punctuation">,</span>
                announcement
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"API请求失败，状态码: </span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> requests<span class="token punctuation">.</span>RequestException <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    error_message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"网络请求失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>show_error_message<span class="token punctuation">(</span>loading_window<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> loading_label<span class="token punctuation">,</span> error_message<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
    error_message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"发生异常: </span><span class="token interpolation"><span class="token punctuation">{</span>ex<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>show_error_message<span class="token punctuation">(</span>loading_window<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> loading_label<span class="token punctuation">,</span> error_message<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">show_error_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loading_window<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> loading_label<span class="token punctuation">,</span> error_message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 停止并销毁进度条和加载标签</span>
    progress<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    progress<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loading_label<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 显示错误信息</span>
    error_label <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>loading_window<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"检查更新失败"</span><span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">"bold"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fg<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">)</span>
    error_label<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    error_details <span class="token operator">=</span> tk<span class="token punctuation">.</span>Text<span class="token punctuation">(</span>loading_window<span class="token punctuation">,</span> wrap<span class="token operator">=</span>tk<span class="token punctuation">.</span>WORD<span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">)</span>
    error_details<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>tk<span class="token punctuation">.</span>END<span class="token punctuation">,</span> error_message<span class="token punctuation">)</span>
    error_details<span class="token punctuation">.</span>config<span class="token punctuation">(</span>state<span class="token operator">=</span>tk<span class="token punctuation">.</span>DISABLED<span class="token punctuation">)</span>
    error_details<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>tk<span class="token punctuation">.</span>BOTH<span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 添加关闭按钮</span>
    tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>loading_window<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"关闭"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>loading_window<span class="token punctuation">.</span>destroy<span class="token punctuation">)</span><span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">show_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loading_window<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> message<span class="token punctuation">,</span> msg_type<span class="token punctuation">,</span> announcement<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 这里假设 show_message 仅在检查更新时使用，因此 reset_ntp_servers 不需要调用它</span>
    <span class="token comment"># 停止并销毁进度条</span>
    <span class="token keyword">if</span> progress<span class="token punctuation">:</span>
    progress<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    progress<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 更新加载窗口内容</span>
    <span class="token keyword">for</span> widget <span class="token keyword">in</span> loading_window<span class="token punctuation">.</span>winfo_children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    widget<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    msg_color <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"info"</span><span class="token punctuation">:</span> <span class="token string">"green"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"red"</span><span class="token punctuation">,</span> <span class="token string">"warning"</span><span class="token punctuation">:</span> <span class="token string">"orange"</span><span class="token punctuation">}</span>
    tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>loading_window<span class="token punctuation">,</span> text<span class="token operator">=</span>message<span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fg<span class="token operator">=</span>msg_color<span class="token punctuation">.</span>get<span class="token punctuation">(</span>msg_type<span class="token punctuation">,</span> <span class="token string">"black"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> announcement<span class="token punctuation">:</span>
    announcement_frame <span class="token operator">=</span> tk<span class="token punctuation">.</span>Frame<span class="token punctuation">(</span>loading_window<span class="token punctuation">)</span>
    announcement_frame<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>tk<span class="token punctuation">.</span>BOTH<span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    announcement_label <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>announcement_frame<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"更新公告:"</span><span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"bold"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    announcement_label<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>anchor<span class="token operator">=</span><span class="token string">"w"</span><span class="token punctuation">)</span>
    
    announcement_text <span class="token operator">=</span> tk<span class="token punctuation">.</span>Text<span class="token punctuation">(</span>announcement_frame<span class="token punctuation">,</span> wrap<span class="token operator">=</span>tk<span class="token punctuation">.</span>WORD<span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">)</span>
    announcement_text<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>tk<span class="token punctuation">.</span>END<span class="token punctuation">,</span> announcement<span class="token punctuation">)</span>
    announcement_text<span class="token punctuation">.</span>config<span class="token punctuation">(</span>state<span class="token operator">=</span>tk<span class="token punctuation">.</span>DISABLED<span class="token punctuation">)</span>
    announcement_text<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>fill<span class="token operator">=</span>tk<span class="token punctuation">.</span>BOTH<span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>loading_window<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"关闭"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>loading_window<span class="token punctuation">.</span>destroy<span class="token punctuation">)</span><span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">show_update_options</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loading_window<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> message<span class="token punctuation">,</span> update_url<span class="token punctuation">,</span> announcement<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 停止并销毁进度条</span>
    <span class="token keyword">if</span> progress<span class="token punctuation">:</span>
    progress<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    progress<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 更新加载窗口内容</span>
    <span class="token keyword">for</span> widget <span class="token keyword">in</span> loading_window<span class="token punctuation">.</span>winfo_children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    widget<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>loading_window<span class="token punctuation">,</span> text<span class="token operator">=</span>message<span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> announcement<span class="token punctuation">:</span>
    announcement_frame <span class="token operator">=</span> tk<span class="token punctuation">.</span>Frame<span class="token punctuation">(</span>loading_window<span class="token punctuation">)</span>
    announcement_frame<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>tk<span class="token punctuation">.</span>BOTH<span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    announcement_label <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>announcement_frame<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"更新公告:"</span><span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"bold"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    announcement_label<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>anchor<span class="token operator">=</span><span class="token string">"w"</span><span class="token punctuation">)</span>
    
    announcement_text <span class="token operator">=</span> tk<span class="token punctuation">.</span>Text<span class="token punctuation">(</span>announcement_frame<span class="token punctuation">,</span> wrap<span class="token operator">=</span>tk<span class="token punctuation">.</span>WORD<span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">)</span>
    announcement_text<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>tk<span class="token punctuation">.</span>END<span class="token punctuation">,</span> announcement<span class="token punctuation">)</span>
    announcement_text<span class="token punctuation">.</span>config<span class="token punctuation">(</span>state<span class="token operator">=</span>tk<span class="token punctuation">.</span>DISABLED<span class="token punctuation">)</span>
    announcement_text<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>fill<span class="token operator">=</span>tk<span class="token punctuation">.</span>BOTH<span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    button_frame <span class="token operator">=</span> tk<span class="token punctuation">.</span>Frame<span class="token punctuation">(</span>loading_window<span class="token punctuation">)</span>
    button_frame<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>button_frame<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"更新"</span><span class="token punctuation">,</span> command<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>update<span class="token punctuation">(</span>update_url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pack<span class="token punctuation">(</span>side<span class="token operator">=</span>tk<span class="token punctuation">.</span>LEFT<span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>button_frame<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"取消"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>loading_window<span class="token punctuation">.</span>destroy<span class="token punctuation">)</span><span class="token punctuation">.</span>pack<span class="token punctuation">(</span>side<span class="token operator">=</span>tk<span class="token punctuation">.</span>LEFT<span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> update_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    webbrowser<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>update_url<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">about_window</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'about_window_instance'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>about_window_instance <span class="token keyword">and</span> self<span class="token punctuation">.</span>about_window_instance<span class="token punctuation">.</span>winfo_exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>about_window_instance<span class="token punctuation">.</span>lift<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
    
    self<span class="token punctuation">.</span>about_window_instance <span class="token operator">=</span> tk<span class="token punctuation">.</span>Toplevel<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>set_window_icon<span class="token punctuation">(</span>self<span class="token punctuation">.</span>about_window_instance<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>about_window_instance<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"关于"</span><span class="token punctuation">)</span>
    <span class="token comment"># 将位置坐标转换为整数</span>
    x_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>screenwidth <span class="token operator">-</span> <span class="token number">370</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    y_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>screenheight <span class="token operator">-</span> <span class="token number">230</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    size_about <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token number">370</span><span class="token punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token number">230</span><span class="token punctuation">}</span></span><span class="token string">+</span><span class="token interpolation"><span class="token punctuation">{</span>x_pos<span class="token punctuation">}</span></span><span class="token string">+</span><span class="token interpolation"><span class="token punctuation">{</span>y_pos<span class="token punctuation">}</span></span><span class="token string">'</span></span>
    self<span class="token punctuation">.</span>about_window_instance<span class="token punctuation">.</span>geometry<span class="token punctuation">(</span>size_about<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>about_window_instance<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 显示加载动画</span>
    loading_label <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>self<span class="token punctuation">.</span>about_window_instance<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"正在加载关于信息，请稍候..."</span><span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    loading_label<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    progress <span class="token operator">=</span> ttk<span class="token punctuation">.</span>Progressbar<span class="token punctuation">(</span>self<span class="token punctuation">.</span>about_window_instance<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'indeterminate'</span><span class="token punctuation">)</span>
    progress<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>tk<span class="token punctuation">.</span>X<span class="token punctuation">)</span>
    progress<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 启动线程加载关于信息</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>load_about_content<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>loading_label<span class="token punctuation">,</span> progress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">load_about_content</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loading_label<span class="token punctuation">,</span> progress<span class="token punctuation">)</span><span class="token punctuation">:</span>
    default_about_content <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token string">"远程公告加载失败，这是默认内容\n"</span>
    <span class="token string">"感谢使用此软件！\n"</span>
    <span class="token string">"QQ：2147606879 \n"</span>
    <span class="token string">"博客地址：especial.top\n"</span>
    <span class="token string">"github仓库：https://github.com/canfengplaeir/synctime\n"</span>
    <span class="token string">"gitee仓库：https://gitee.com/canfeng_plaeir/synctime"</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>self<span class="token punctuation">.</span>about_api<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        about_content <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'aboutContent'</span><span class="token punctuation">,</span> default_about_content<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        about_content <span class="token operator">=</span> default_about_content
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"加载关于信息失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    about_content <span class="token operator">=</span> default_about_content
    
    <span class="token comment"># 更新关于窗口内容</span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>display_about_content<span class="token punctuation">(</span>loading_label<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> about_content<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">display_about_content</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loading_label<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> about_content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 停止并销毁进度条和加载标签</span>
    progress<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    progress<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loading_label<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    text_about <span class="token operator">=</span> tk<span class="token punctuation">.</span>Text<span class="token punctuation">(</span>self<span class="token punctuation">.</span>about_window_instance<span class="token punctuation">,</span> wrap<span class="token operator">=</span>tk<span class="token punctuation">.</span>CHAR<span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    text_about<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>tk<span class="token punctuation">.</span>INSERT<span class="token punctuation">,</span> about_content<span class="token punctuation">)</span>
    text_about<span class="token punctuation">.</span>config<span class="token punctuation">(</span>state<span class="token operator">=</span>tk<span class="token punctuation">.</span>DISABLED<span class="token punctuation">)</span>
    text_about<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">set_window_icon</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> window<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    设置顶层窗口的图标为主窗口的图标
    """</span>
    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'icon_image'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    window<span class="token punctuation">.</span>iconphoto<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>icon_image<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">show_sync_animation</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建同步动画窗口</span>
    self<span class="token punctuation">.</span>sync_window <span class="token operator">=</span> tk<span class="token punctuation">.</span>Toplevel<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>set_window_icon<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sync_window<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>sync_window<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"同步时间"</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>sync_window<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    x_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>screenwidth <span class="token operator">-</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    y_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>screenheight <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    size_geo <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'300x100+</span><span class="token interpolation"><span class="token punctuation">{</span>x_pos<span class="token punctuation">}</span></span><span class="token string">+</span><span class="token interpolation"><span class="token punctuation">{</span>y_pos<span class="token punctuation">}</span></span><span class="token string">'</span></span>
    self<span class="token punctuation">.</span>sync_window<span class="token punctuation">.</span>geometry<span class="token punctuation">(</span>size_geo<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>sync_window<span class="token punctuation">.</span>protocol<span class="token punctuation">(</span><span class="token string">"WM_DELETE_WINDOW"</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">)</span>  <span class="token comment"># 禁用关闭按钮</span>
    
    tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sync_window<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"正在同步时间，请稍候..."</span><span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    progress <span class="token operator">=</span> ttk<span class="token punctuation">.</span>Progressbar<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sync_window<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'indeterminate'</span><span class="token punctuation">)</span>
    progress<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>tk<span class="token punctuation">.</span>X<span class="token punctuation">)</span>
    progress<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>sync_progress <span class="token operator">=</span> progress
    
    <span class="token keyword">def</span> <span class="token function">hide_sync_animation</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'sync_window'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>sync_progress<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>sync_window<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">compare_versions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> version1<span class="token punctuation">,</span> version2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    比较两个版本号字符串
    """</span>
    v1 <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> version1<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    v2 <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> version2<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>v1 <span class="token operator">&gt;</span> v2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>v1 <span class="token operator">&lt;</span> v2<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">load_ntp_servers</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ntp_servers_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ntp_servers <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'ntp_servers'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> FileNotFoundError<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ntp_servers.json文件未找到，使用默认NTP服务器列表。"</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>ntp_servers <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">'edu.ntp.org.cn'</span><span class="token punctuation">,</span> 
        <span class="token string">"ntp.ntsc.ac.cn"</span><span class="token punctuation">,</span>
        <span class="token string">"cn.ntp.org.cn"</span><span class="token punctuation">,</span>
        <span class="token string">"ntp1.aliyun.com"</span><span class="token punctuation">,</span>
        <span class="token string">"ntp2.aliyun.com"</span><span class="token punctuation">,</span>
        <span class="token string">"ntp3.aliyun.com"</span><span class="token punctuation">,</span>
        <span class="token string">"ntp4.aliyun.com"</span><span class="token punctuation">,</span>
        <span class="token string">"ntp5.aliyun.com"</span><span class="token punctuation">,</span>
        <span class="token string">"ntp6.aliyun.com"</span><span class="token punctuation">,</span>
        <span class="token string">"ntp7.aliyun.com"</span><span class="token punctuation">,</span>
        <span class="token string">"ntp.tencent.com"</span><span class="token punctuation">,</span>
        <span class="token string">'tw.ntp.org.cn'</span><span class="token punctuation">,</span> 
        <span class="token string">'us.ntp.org.cn'</span><span class="token punctuation">,</span> 
        <span class="token string">'cn.pool.ntp.org'</span><span class="token punctuation">,</span> 
        <span class="token string">'jp.ntp.org.cn'</span>
    <span class="token punctuation">]</span>
    self<span class="token punctuation">.</span>save_ntp_servers<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">save_ntp_servers</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ntp_servers_file<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"ntp_servers"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>ntp_servers<span class="token punctuation">}</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"NTP服务器列表已保存。"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"保存NTP服务器列表失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">reset_ntp_servers</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>ntp_servers <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'edu.ntp.org.cn'</span><span class="token punctuation">,</span> 
    <span class="token string">"ntp.ntsc.ac.cn"</span><span class="token punctuation">,</span>
    <span class="token string">"cn.ntp.org.cn"</span><span class="token punctuation">,</span>
    <span class="token string">"ntp1.aliyun.com"</span><span class="token punctuation">,</span>
    <span class="token string">"ntp2.aliyun.com"</span><span class="token punctuation">,</span>
    <span class="token string">"ntp3.aliyun.com"</span><span class="token punctuation">,</span>
    <span class="token string">"ntp4.aliyun.com"</span><span class="token punctuation">,</span>
    <span class="token string">"ntp5.aliyun.com"</span><span class="token punctuation">,</span>
    <span class="token string">"ntp6.aliyun.com"</span><span class="token punctuation">,</span>
    <span class="token string">"ntp7.aliyun.com"</span><span class="token punctuation">,</span>
    <span class="token string">"ntp.tencent.com"</span><span class="token punctuation">,</span>
    <span class="token string">'tw.ntp.org.cn'</span><span class="token punctuation">,</span> 
    <span class="token string">'us.ntp.org.cn'</span><span class="token punctuation">,</span> 
    <span class="token string">'cn.pool.ntp.org'</span><span class="token punctuation">,</span> 
    <span class="token string">'jp.ntp.org.cn'</span>
    <span class="token punctuation">]</span>
    self<span class="token punctuation">.</span>save_ntp_servers<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>get_children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> server <span class="token keyword">in</span> self<span class="token punctuation">.</span>ntp_servers<span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> tk<span class="token punctuation">.</span>END<span class="token punctuation">,</span> values<span class="token operator">=</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token string">"待测"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    messagebox<span class="token punctuation">.</span>showinfo<span class="token punctuation">(</span><span class="token string">"重置成功"</span><span class="token punctuation">,</span> <span class="token string">"已重置NTP服务器列表为默认值。"</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">open_settings</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'settings_window_instance'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>settings_window_instance <span class="token keyword">and</span> self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">.</span>winfo_exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">.</span>lift<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
    
    self<span class="token punctuation">.</span>settings_window_instance <span class="token operator">=</span> tk<span class="token punctuation">.</span>Toplevel<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>set_window_icon<span class="token punctuation">(</span>self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"设置"</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    size_geo <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'500x500+</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>screenwidth <span class="token operator">-</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">+</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>screenheight <span class="token operator">-</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>
    self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">.</span>geometry<span class="token punctuation">(</span>size_geo<span class="token punctuation">)</span>
    
    <span class="token comment"># NTP服务器列表框使用Treeview</span>
    ntp_frame <span class="token operator">=</span> tk<span class="token punctuation">.</span>Frame<span class="token punctuation">(</span>self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">)</span>
    ntp_frame<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>tk<span class="token punctuation">.</span>BOTH<span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>ntp_frame<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"NTP服务器列表:"</span><span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">"bold"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pack<span class="token punctuation">(</span>anchor<span class="token operator">=</span><span class="token string">"w"</span><span class="token punctuation">)</span>
    
    columns <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"服务器地址"</span><span class="token punctuation">,</span> <span class="token string">"延迟(ms)"</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>ntp_tree <span class="token operator">=</span> ttk<span class="token punctuation">.</span>Treeview<span class="token punctuation">(</span>ntp_frame<span class="token punctuation">,</span> columns<span class="token operator">=</span>columns<span class="token punctuation">,</span> show<span class="token operator">=</span><span class="token string">'headings'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> col <span class="token keyword">in</span> columns<span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>heading<span class="token punctuation">(</span>col<span class="token punctuation">,</span> text<span class="token operator">=</span>col<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>column<span class="token punctuation">(</span>col<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> anchor<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>fill<span class="token operator">=</span>tk<span class="token punctuation">.</span>BOTH<span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> server <span class="token keyword">in</span> self<span class="token punctuation">.</span>ntp_servers<span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> tk<span class="token punctuation">.</span>END<span class="token punctuation">,</span> values<span class="token operator">=</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token string">"待测"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 按钮框</span>
    button_frame <span class="token operator">=</span> tk<span class="token punctuation">.</span>Frame<span class="token punctuation">(</span>self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">)</span>
    button_frame<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    add_button <span class="token operator">=</span> tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>button_frame<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"添加服务器"</span><span class="token punctuation">,</span> command<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>add_ntp_server<span class="token punctuation">(</span>self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">)</span><span class="token punctuation">)</span>
    delete_button <span class="token operator">=</span> tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>button_frame<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"删除选中"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>delete_selected_ntp_server<span class="token punctuation">)</span>
    reset_button <span class="token operator">=</span> tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>button_frame<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"重置为默认"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>reset_ntp_servers<span class="token punctuation">)</span>
    
    add_button<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>side<span class="token operator">=</span>tk<span class="token punctuation">.</span>LEFT<span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    delete_button<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>side<span class="token operator">=</span>tk<span class="token punctuation">.</span>LEFT<span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    reset_button<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>side<span class="token operator">=</span>tk<span class="token punctuation">.</span>LEFT<span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Ping按钮</span>
    ping_button <span class="token operator">=</span> tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"Ping所有服务器"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>self<span class="token punctuation">.</span>ping_all_ntp_servers<span class="token punctuation">)</span>
    ping_button<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">add_ntp_server</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> parent_window<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">save_new_server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    new_server <span class="token operator">=</span> entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> new_server <span class="token keyword">and</span> new_server <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>ntp_servers<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>ntp_servers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_server<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>save_ntp_servers<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> tk<span class="token punctuation">.</span>END<span class="token punctuation">,</span> values<span class="token operator">=</span><span class="token punctuation">(</span>new_server<span class="token punctuation">,</span> <span class="token string">"待测"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        add_window<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        messagebox<span class="token punctuation">.</span>showwarning<span class="token punctuation">(</span><span class="token string">"无效输入"</span><span class="token punctuation">,</span> <span class="token string">"请输入有效且未存在的NTP服务器地址。"</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>add_window<span class="token punctuation">)</span>
    
    add_window <span class="token operator">=</span> tk<span class="token punctuation">.</span>Toplevel<span class="token punctuation">(</span>parent_window<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>set_window_icon<span class="token punctuation">(</span>add_window<span class="token punctuation">)</span>
    add_window<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"添加NTP服务器"</span><span class="token punctuation">)</span>
    add_window<span class="token punctuation">.</span>resizable<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 获取屏幕尺寸</span>
    screen_width <span class="token operator">=</span> add_window<span class="token punctuation">.</span>winfo_screenwidth<span class="token punctuation">(</span><span class="token punctuation">)</span>
    screen_height <span class="token operator">=</span> add_window<span class="token punctuation">.</span>winfo_screenheight<span class="token punctuation">(</span><span class="token punctuation">)</span>
    window_width <span class="token operator">=</span> <span class="token number">300</span>
    window_height <span class="token operator">=</span> <span class="token number">150</span>
    x_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>screen_width <span class="token operator">-</span> window_width<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    y_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>screen_height <span class="token operator">-</span> window_height<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    add_window<span class="token punctuation">.</span>geometry<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>window_width<span class="token punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token punctuation">{</span>window_height<span class="token punctuation">}</span></span><span class="token string">+</span><span class="token interpolation"><span class="token punctuation">{</span>x_pos<span class="token punctuation">}</span></span><span class="token string">+</span><span class="token interpolation"><span class="token punctuation">{</span>y_pos<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>add_window<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"服务器地址:"</span><span class="token punctuation">,</span> font<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    entry <span class="token operator">=</span> tk<span class="token punctuation">.</span>Entry<span class="token punctuation">(</span>add_window<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">)</span>
    entry<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>add_window<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"添加"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>save_new_server<span class="token punctuation">)</span><span class="token punctuation">.</span>pack<span class="token punctuation">(</span>pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">delete_selected_ntp_server</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    selected <span class="token operator">=</span> self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>selection<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> selected<span class="token punctuation">:</span>
    item <span class="token operator">=</span> selected<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    server <span class="token operator">=</span> self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>item<span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">'values'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    confirm <span class="token operator">=</span> messagebox<span class="token punctuation">.</span>askyesno<span class="token punctuation">(</span><span class="token string">"确认删除"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"是否删除NTP服务器: </span><span class="token interpolation"><span class="token punctuation">{</span>server<span class="token punctuation">}</span></span><span class="token string">?"</span></span><span class="token punctuation">,</span> parent<span class="token operator">=</span>self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">)</span>
    <span class="token keyword">if</span> confirm<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        index <span class="token operator">=</span> self<span class="token punctuation">.</span>ntp_servers<span class="token punctuation">.</span>index<span class="token punctuation">(</span>server<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ntp_servers<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>index<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>save_ntp_servers<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> server <span class="token operator">==</span> self<span class="token punctuation">.</span>primary_ntp_server<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>primary_ntp_server <span class="token operator">=</span> self<span class="token punctuation">.</span>ntp_servers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>ntp_servers <span class="token keyword">else</span> <span class="token boolean">None</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
    messagebox<span class="token punctuation">.</span>showwarning<span class="token punctuation">(</span><span class="token string">"未选择"</span><span class="token punctuation">,</span> <span class="token string">"请先选择要删除的NTP服务器。"</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">ping_all_ntp_servers</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>ping_ntp_servers_task<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">ping_ntp_servers_task</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ping_results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> server <span class="token keyword">in</span> self<span class="token punctuation">.</span>ntp_servers<span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 使用ping命令测量延迟</span>
        response <span class="token operator">=</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'ping -n 1 </span><span class="token interpolation"><span class="token punctuation">{</span>server<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 解析延迟时间</span>
        latency <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_ping_latency<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        <span class="token keyword">if</span> latency <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            ping_results<span class="token punctuation">[</span>server<span class="token punctuation">]</span> <span class="token operator">=</span> latency
            <span class="token comment"># 更新Treeview中的延迟</span>
            <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>get_children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>item<span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">'values'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> server<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>ntp_tree<span class="token punctuation">.</span>item<span class="token punctuation">(</span>item<span class="token punctuation">,</span> values<span class="token operator">=</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>latency<span class="token punctuation">}</span></span><span class="token string"> ms"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Ping </span><span class="token interpolation"><span class="token punctuation">{</span>server<span class="token punctuation">}</span></span><span class="token string"> 失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> ping_results<span class="token punctuation">:</span>
    <span class="token comment"># 找到延迟最低的服务器</span>
    best_server <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>ping_results<span class="token punctuation">,</span> key<span class="token operator">=</span>ping_results<span class="token punctuation">.</span>get<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>primary_ntp_server <span class="token operator">=</span> best_server
    message <span class="token operator">=</span> <span class="token string">"Ping结果：\n"</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>s<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>ms<span class="token punctuation">}</span></span><span class="token string"> ms"</span></span> <span class="token keyword">for</span> s<span class="token punctuation">,</span> ms <span class="token keyword">in</span> ping_results<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"\n\n优选服务器设置为: </span><span class="token interpolation"><span class="token punctuation">{</span>best_server<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> messagebox<span class="token punctuation">.</span>showinfo<span class="token punctuation">(</span><span class="token string">"Ping结果"</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> parent<span class="token operator">=</span>self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>root<span class="token punctuation">.</span>after<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> messagebox<span class="token punctuation">.</span>showerror<span class="token punctuation">(</span><span class="token string">"错误"</span><span class="token punctuation">,</span> <span class="token string">"无法Ping任何NTP服务器。"</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>self<span class="token punctuation">.</span>settings_window_instance<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">parse_ping_latency</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ping_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> re
    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'Time[=&lt;]\s*(\d+)ms'</span><span class="token punctuation">,</span> ping_response<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token comment"># 其他方法保持不变...</span>
    
    <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    root_window <span class="token operator">=</span> ttk<span class="token punctuation">.</span>Window<span class="token punctuation">(</span>themename<span class="token operator">=</span><span class="token string">"litera"</span><span class="token punctuation">)</span>
    app <span class="token operator">=</span> SyncTimeApp<span class="token punctuation">(</span>root_window<span class="token punctuation">)</span>
    root_window<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
                <div class="toolbar c-title c-hr">
                    <div class="toolbar-item"><span>Python</span></div>
                    <div class="custom-item absolute top-0"><i
                            class="haofont hao-icon-paste copy-button code-copy cursor-pointer"></i><i
                            class="fa-sharp fa-solid haofont hao-icon-angle-down code-expander cursor-pointer"></i>
                    </div>
                </div>
                <div class="code-expand-btn"><i class="haofont hao-icon-angle-double-down"></i></div>
            </div>
            <p style="">事实上该工具很多代码都是用AI写的，所以并没有用多少时间。AI真是太好用啦！</p>
            <h1 style="" id="todo">TODO</h1>
            <ol>
                <li>
                    <p style="">添加http方法获取时间</p>
                </li>
                <li>
                    <p style="">防止时间偏移过大导致请求不成功</p>
                </li>
                <li>
                    <p style="">添加开机自启动选项</p>
                </li>
                <li>
                    <p style="">更新主界面文本</p>
                </li>
            </ol>
            <p style=""></p>
        </article>
</body>

</html>